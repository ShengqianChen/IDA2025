# Step 1.5: æ™ºèƒ½å“åº”å¤„ç† - å®æ–½å®ŒæˆæŠ¥å‘Š

## ğŸ¯ **å®æ–½ç›®æ ‡**
å®ç°æ™ºèƒ½å“åº”å¤„ç†ç³»ç»Ÿï¼ŒåŒ…æ‹¬æ ¹æ®å¯¹è¯ç±»å‹è¿›è¡Œå“åº”å¤„ç†ã€å“åº”è´¨é‡è¯„ä¼°ã€å“åº”ä¼˜åŒ–å’Œé”™è¯¯å¤„ç†ï¼Œç¡®ä¿ä¸åŒå¯¹è¯ç±»å‹èƒ½å¤Ÿè·å¾—æœ€é€‚åˆçš„å“åº”æ ¼å¼å’Œè´¨é‡ã€‚

## âœ… **å·²å®Œæˆçš„å·¥ä½œ**

### **1. æ™ºèƒ½å“åº”å¤„ç†æ ¸å¿ƒå‡½æ•°**

#### **ä¸»è¦å¤„ç†å‡½æ•°**ï¼š
```python
def deepseek_r1_api_call(prompt: str, session_context: str = "", conversation_type: str = "fault_analysis") -> str:
    """æ™ºèƒ½ DeepSeek-R1 API è°ƒç”¨å‡½æ•°"""
    # æ„å»ºä¸Šä¸‹æ–‡ä¿¡æ¯
    context = {
        'context': session_context,
        'logs': []  # è¿™é‡Œå¯ä»¥æ·»åŠ æ£€ç´¢åˆ°çš„æ—¥å¿—ä¿¡æ¯
    }
    
    # ç”Ÿæˆå“åº”
    result = system.generate_response(query, context)
    
    # æ ¹æ®å¯¹è¯ç±»å‹è¿›è¡Œæ™ºèƒ½å¤„ç†
    processed_response = process_response_by_type(raw_response, conversation_type)
    
    return processed_response
```

#### **å“åº”ç±»å‹å¤„ç†**ï¼š
```python
def process_response_by_type(response: str, conversation_type: str) -> str:
    """æ ¹æ®å¯¹è¯ç±»å‹æ™ºèƒ½å¤„ç†å“åº”"""
    if conversation_type == "fault_analysis":
        # æ•…éšœåˆ†æç±»å‹ï¼šJSONæ ¼å¼ï¼Œéœ€è¦è½¬æ¢ä¸ºMarkdown
        return json_to_markdown(response)
    else:
        # å…¶ä»–ç±»å‹ï¼šå·²ç»æ˜¯Markdownæ ¼å¼ï¼Œç›´æ¥è¿”å›
        return response
```

### **2. å“åº”è´¨é‡è¯„ä¼°ç³»ç»Ÿ**

#### **è´¨é‡è¯„ä¼°æŒ‡æ ‡**ï¼š
```python
def assess_response_quality(response: str, conversation_type: str) -> dict:
    """è¯„ä¼°å“åº”è´¨é‡"""
    quality_metrics = {
        'length': len(response),
        'has_structure': False,
        'has_keywords': False,
        'format_correct': False,
        'completeness_score': 0,
        'relevance_score': 0
    }
```

#### **è¯„ä¼°ç»´åº¦**ï¼š
- **é•¿åº¦**: å“åº”å†…å®¹é•¿åº¦
- **ç»“æ„**: æ˜¯å¦æœ‰æ­£ç¡®çš„ç»“æ„ï¼ˆJSONæˆ–Markdownï¼‰
- **å…³é”®è¯**: æ˜¯å¦åŒ…å«ç›¸å…³å…³é”®è¯
- **æ ¼å¼æ­£ç¡®æ€§**: æ ¼å¼æ˜¯å¦ç¬¦åˆè¦æ±‚
- **å®Œæ•´æ€§å¾—åˆ†**: å†…å®¹å®Œæ•´æ€§è¯„ä¼°
- **ç›¸å…³æ€§å¾—åˆ†**: å†…å®¹ç›¸å…³æ€§è¯„ä¼°

#### **è¯„ä¼°é€»è¾‘**ï¼š
- **æ•…éšœåˆ†æç±»å‹**: æ£€æŸ¥JSONç»“æ„å’Œå¿…éœ€å­—æ®µ
- **å…¶ä»–ç±»å‹**: æ£€æŸ¥Markdownç»“æ„å’Œå…ƒç´ 
- **å…³é”®è¯æ£€æµ‹**: æ£€æµ‹æŠ€æœ¯ç›¸å…³å…³é”®è¯
- **ç›¸å…³æ€§è®¡ç®—**: åŸºäºå…³é”®è¯å¯†åº¦è®¡ç®—

### **3. å“åº”ä¼˜åŒ–ç³»ç»Ÿ**

#### **ä¼˜åŒ–ç­–ç•¥**ï¼š
```python
def optimize_response(response: str, conversation_type: str) -> str:
    """ä¼˜åŒ–å“åº”å†…å®¹"""
    if conversation_type == "fault_analysis":
        # æ•…éšœåˆ†æç±»å‹ï¼šç¡®ä¿JSONæ ¼å¼æ­£ç¡®
        return optimize_json_response(response)
    else:
        # å…¶ä»–ç±»å‹ï¼šä¼˜åŒ–Markdownæ ¼å¼
        return optimize_markdown_response(response)
```

#### **JSONå“åº”ä¼˜åŒ–**ï¼š
```python
def optimize_json_response(response: str) -> str:
    """ä¼˜åŒ–JSONå“åº”"""
    # æ¸…ç†å“åº”
    cleaned_response = re.sub(r'<[^>]+>', '', response)  # ç§»é™¤HTMLæ ‡ç­¾
    cleaned_response = re.sub(r'```json\s*', '', cleaned_response)  # ç§»é™¤markdownä»£ç å—æ ‡è®°
    
    # ç¡®ä¿æ‰€æœ‰å¿…éœ€å­—æ®µå­˜åœ¨
    required_fields = {
        "fault_summary": {...},
        "root_cause_analysis": {...},
        "solutions": {...},
        "monitoring_recommendations": []
    }
    
    # å¡«å……ç¼ºå¤±å­—æ®µ
    for field, default_value in required_fields.items():
        if field not in json_data:
            json_data[field] = default_value
```

#### **Markdownå“åº”ä¼˜åŒ–**ï¼š
```python
def optimize_markdown_response(response: str) -> str:
    """ä¼˜åŒ–Markdownå“åº”"""
    # æ¸…ç†HTMLæ ‡ç­¾
    cleaned_response = re.sub(r'<[^>]+>', '', response)
    
    # ç¡®ä¿æ ‡é¢˜æ ¼å¼æ­£ç¡®
    lines = cleaned_response.split('\n')
    optimized_lines = []
    
    for line in lines:
        if line.startswith('#'):
            # æ ‡é¢˜è¡Œ
            optimized_lines.append(line)
        elif line.startswith('-') or line.startswith('*'):
            # åˆ—è¡¨é¡¹
            optimized_lines.append(line)
        elif line.startswith('```'):
            # ä»£ç å—
            optimized_lines.append(line)
        else:
            # æ™®é€šæ–‡æœ¬
            optimized_lines.append(line)
```

### **4. APIç«¯ç‚¹æ™ºèƒ½å¤„ç†**

#### **æ™ºèƒ½è°ƒç”¨é€»è¾‘**ï¼š
```python
# æ™ºèƒ½è°ƒç”¨å¤§æ¨¡å‹ï¼Œä¼ å…¥ä¸Šä¸‹æ–‡å’Œå¯¹è¯ç±»å‹
raw_reply = deepseek_r1_api_call(
    prompt=user_input,  # åªä¼ å…¥å½“å‰ç”¨æˆ·è¾“å…¥
    session_context=session.context,  # ä¼ å…¥å†å²ä¸Šä¸‹æ–‡
    conversation_type=session.conversation_type or "fault_analysis"  # ä¼ å…¥å¯¹è¯ç±»å‹
)

# å“åº”è´¨é‡è¯„ä¼°å’Œä¼˜åŒ–
quality_metrics = assess_response_quality(raw_reply, session.conversation_type or "fault_analysis")
reply = optimize_response(raw_reply, session.conversation_type or "fault_analysis")

# å¦‚æœè´¨é‡ä¸è¾¾æ ‡ï¼Œè®°å½•è­¦å‘Š
if quality_metrics['completeness_score'] < 0.5:
    logger.warning(f"å“åº”å®Œæ•´æ€§å¾—åˆ†è¾ƒä½: {quality_metrics['completeness_score']}")
if quality_metrics['relevance_score'] < 0.01:
    logger.warning(f"å“åº”ç›¸å…³æ€§å¾—åˆ†è¾ƒä½: {quality_metrics['relevance_score']}")
```

#### **æ™ºèƒ½ä¸Šä¸‹æ–‡æ›´æ–°**ï¼š
```python
# æ™ºèƒ½ä¸Šä¸‹æ–‡æ›´æ–°ï¼ˆå¸¦å‹ç¼©ï¼‰
session.update_context_with_compression(user_input, reply)

# æ™ºèƒ½å¯¹è¯ç±»å‹è¯†åˆ«å’Œæ›´æ–°
detected_type = temp_system.detect_conversation_type(user_input, session.context)
if session.conversation_type != detected_type.value:
    session.conversation_type = detected_type.value
    session.save()
```

### **5. é”™è¯¯å¤„ç†å’Œå®¹é”™æœºåˆ¶**

#### **é”™è¯¯å¤„ç†ç­–ç•¥**ï¼š
- **JSONè§£æé”™è¯¯**: è¿”å›åŸå§‹å“åº”
- **ä¼˜åŒ–å¤±è´¥**: è¿”å›åŸå§‹å“åº”
- **è´¨é‡è¯„ä¼°å¤±è´¥**: è®°å½•è­¦å‘Šä½†ä¸ä¸­æ–­æµç¨‹
- **å¯¹è¯ç±»å‹è¯†åˆ«å¤±è´¥**: ä¿æŒç°æœ‰ç±»å‹

#### **å®¹é”™æœºåˆ¶**ï¼š
```python
try:
    # ä¸»è¦å¤„ç†é€»è¾‘
    processed_response = process_response_by_type(response, conversation_type)
except Exception as e:
    print(f"âš ï¸ å“åº”å¤„ç†å‡ºé”™: {e}")
    # å‡ºé”™æ—¶è¿”å›åŸå§‹å“åº”
    return response
```

### **6. è´¨é‡ç›‘æ§å’Œæ—¥å¿—**

#### **è´¨é‡ç›‘æ§**ï¼š
- **å®Œæ•´æ€§å¾—åˆ†**: ç›‘æ§å“åº”å®Œæ•´æ€§
- **ç›¸å…³æ€§å¾—åˆ†**: ç›‘æ§å“åº”ç›¸å…³æ€§
- **æ ¼å¼æ­£ç¡®æ€§**: ç›‘æ§æ ¼å¼ç¬¦åˆæ€§
- **å…³é”®è¯è¦†ç›–**: ç›‘æ§å…³é”®è¯è¦†ç›–åº¦

#### **æ—¥å¿—è®°å½•**ï¼š
- **å“åº”è´¨é‡æŒ‡æ ‡**: è®°å½•è¯¦ç»†çš„è´¨é‡æŒ‡æ ‡
- **ä¼˜åŒ–ç»“æœ**: è®°å½•ä¼˜åŒ–å‰åçš„å¯¹æ¯”
- **é”™è¯¯ä¿¡æ¯**: è®°å½•å¤„ç†è¿‡ç¨‹ä¸­çš„é”™è¯¯
- **è­¦å‘Šä¿¡æ¯**: è®°å½•è´¨é‡ä¸è¾¾æ ‡çš„æƒ…å†µ

## ğŸ”§ **æ ¸å¿ƒåŠŸèƒ½å®ç°**

### **1. æ™ºèƒ½å“åº”å¤„ç†**
- æ ¹æ®å¯¹è¯ç±»å‹é€‰æ‹©å¤„ç†ç­–ç•¥
- æ”¯æŒJSONå’ŒMarkdownä¸¤ç§æ ¼å¼
- è‡ªåŠ¨æ ¼å¼è½¬æ¢å’Œä¼˜åŒ–

### **2. è´¨é‡è¯„ä¼°ç³»ç»Ÿ**
- å¤šç»´åº¦è´¨é‡æŒ‡æ ‡è¯„ä¼°
- å®æ—¶è´¨é‡ç›‘æ§
- è´¨é‡ä¸è¾¾æ ‡å‘Šè­¦

### **3. å“åº”ä¼˜åŒ–ç³»ç»Ÿ**
- JSONå“åº”å®Œæ•´æ€§æ£€æŸ¥
- Markdownå“åº”æ ¼å¼ä¼˜åŒ–
- ç¼ºå¤±å­—æ®µè‡ªåŠ¨å¡«å……

### **4. é”™è¯¯å¤„ç†æœºåˆ¶**
- å®Œå–„çš„å¼‚å¸¸å¤„ç†
- å®¹é”™æœºåˆ¶ä¿è¯æœåŠ¡å¯ç”¨æ€§
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•

### **5. æ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†**
- å¸¦å‹ç¼©çš„ä¸Šä¸‹æ–‡æ›´æ–°
- è‡ªåŠ¨å¯¹è¯ç±»å‹è¯†åˆ«
- ä¸Šä¸‹æ–‡è´¨é‡è¯„ä¼°

## ğŸ“Š **æµ‹è¯•ç»“æœ**

### **æµ‹è¯•ç”¨ä¾‹1: æ•…éšœåˆ†æå“åº”å¤„ç†**
```
å¤„ç†å‰é•¿åº¦: 1418 å­—ç¬¦
å¤„ç†åé•¿åº¦: 483 å­—ç¬¦
å‹ç¼©æ¯”: 66.0%
```

### **æµ‹è¯•ç”¨ä¾‹2: è·Ÿè¿›é—®é¢˜å“åº”å¤„ç†**
```
å¤„ç†å‰é•¿åº¦: 396 å­—ç¬¦
å¤„ç†åé•¿åº¦: 396 å­—ç¬¦
ä¿æŒç‡: 100%
```

### **æµ‹è¯•ç”¨ä¾‹3: å“åº”è´¨é‡è¯„ä¼°**
```
æ•…éšœåˆ†æå“åº”è´¨é‡:
  length: 1418
  has_structure: True
  has_keywords: True
  format_correct: True
  completeness_score: 1.0
  relevance_score: 0.013399153737658674

è·Ÿè¿›é—®é¢˜å“åº”è´¨é‡:
  length: 396
  has_structure: True
  has_keywords: True
  format_correct: True
  completeness_score: 0.8333333333333334
  relevance_score: 0.047979797979797977
```

### **æµ‹è¯•ç”¨ä¾‹4: JSONå“åº”ä¼˜åŒ–**
```
ä¼˜åŒ–å‰é•¿åº¦: 123 å­—ç¬¦
ä¼˜åŒ–åé•¿åº¦: 513 å­—ç¬¦
ä¼˜åŒ–ç‡: 317.1%
```

### **æµ‹è¯•ç”¨ä¾‹5: Markdownå“åº”ä¼˜åŒ–**
```
ä¼˜åŒ–å‰é•¿åº¦: 117 å­—ç¬¦
ä¼˜åŒ–åé•¿åº¦: 68 å­—ç¬¦
ä¼˜åŒ–ç‡: 41.9%
```

### **æµ‹è¯•ç”¨ä¾‹6: ç»¼åˆå“åº”ä¼˜åŒ–**
```
æ•…éšœåˆ†æç»¼åˆä¼˜åŒ–:
ä¼˜åŒ–å‰é•¿åº¦: 1418 å­—ç¬¦
ä¼˜åŒ–åé•¿åº¦: 1400 å­—ç¬¦
ä¼˜åŒ–ç‡: 98.7%

è·Ÿè¿›é—®é¢˜ç»¼åˆä¼˜åŒ–:
ä¼˜åŒ–å‰é•¿åº¦: 396 å­—ç¬¦
ä¼˜åŒ–åé•¿åº¦: 300 å­—ç¬¦
ä¼˜åŒ–ç‡: 75.8%
```

### **æµ‹è¯•ç”¨ä¾‹7: é”™è¯¯å¤„ç†**
```
âœ… æ— æ•ˆJSONå¤„ç†æˆåŠŸ: è¿”å›åŸå§‹å“åº”
âœ… ç©ºå“åº”å¤„ç†æˆåŠŸ: è¿”å›ç©ºå“åº”
```

## ğŸ“ˆ **æ€§èƒ½æŒ‡æ ‡**

### **å¤„ç†æ•ˆæœ**ï¼š
- **æ•…éšœåˆ†æ**: å‹ç¼©æ¯”66%ï¼Œå®Œæ•´æ€§å¾—åˆ†1.0
- **è·Ÿè¿›é—®é¢˜**: ä¿æŒç‡100%ï¼Œå®Œæ•´æ€§å¾—åˆ†0.83
- **JSONä¼˜åŒ–**: ä¼˜åŒ–ç‡317%ï¼Œå­—æ®µå®Œæ•´æ€§100%
- **Markdownä¼˜åŒ–**: ä¼˜åŒ–ç‡41.9%ï¼Œæ ¼å¼æ­£ç¡®æ€§100%

### **è´¨é‡æŒ‡æ ‡**ï¼š
- **ç»“æ„å®Œæ•´æ€§**: 100%
- **æ ¼å¼æ­£ç¡®æ€§**: 100%
- **å…³é”®è¯è¦†ç›–**: 100%
- **ç›¸å…³æ€§å¾—åˆ†**: 0.01-0.05

### **å¤„ç†é€Ÿåº¦**ï¼š
- **å“åº”å¤„ç†**: æ¯«ç§’çº§
- **è´¨é‡è¯„ä¼°**: æ¯«ç§’çº§
- **å“åº”ä¼˜åŒ–**: æ¯«ç§’çº§
- **é”™è¯¯å¤„ç†**: æ¯«ç§’çº§

## ğŸ¯ **ä¸‹ä¸€æ­¥è®¡åˆ’**

### **Step 2: å¤šè½®å¯¹è¯åœºæ™¯æµ‹è¯•**
- æµ‹è¯•ç«¯åˆ°ç«¯å¤šè½®å¯¹è¯æµç¨‹
- éªŒè¯ä¸Šä¸‹æ–‡ç®¡ç†æ•ˆæœ
- æµ‹è¯•å“åº”è´¨é‡ç¨³å®šæ€§

### **Step 3: å‰ç«¯æ˜¾ç¤ºé€»è¾‘æ›´æ–°**
- æ›´æ–°å‰ç«¯ä»¥æ”¯æŒæ–°çš„å“åº”æ ¼å¼
- ä¼˜åŒ–Markdownæ¸²æŸ“æ•ˆæœ
- æµ‹è¯•å“åº”æ˜¾ç¤ºè´¨é‡

## âœ… **æˆåŠŸæ ‡å‡†è¾¾æˆ**

- âœ… æ™ºèƒ½å“åº”å¤„ç†å®Œæˆ
- âœ… å“åº”è´¨é‡è¯„ä¼°å®Œæˆ
- âœ… å“åº”ä¼˜åŒ–ç³»ç»Ÿå®Œæˆ
- âœ… é”™è¯¯å¤„ç†æœºåˆ¶å®Œæˆ
- âœ… APIç«¯ç‚¹æ™ºèƒ½å¤„ç†å®Œæˆ
- âœ… è´¨é‡ç›‘æ§å’Œæ—¥å¿—å®Œæˆ
- âœ… æµ‹è¯•éªŒè¯é€šè¿‡
- âœ… 7ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡

## ğŸ‰ **æ€»ç»“**

**Step 1.5 å®æ–½å®Œæˆï¼** 

æ™ºèƒ½å“åº”å¤„ç†ç³»ç»Ÿå·²ç»æˆåŠŸå®ç°ï¼Œæ”¯æŒæ ¹æ®å¯¹è¯ç±»å‹è¿›è¡Œæ™ºèƒ½å¤„ç†ã€è´¨é‡è¯„ä¼°ã€å“åº”ä¼˜åŒ–å’Œé”™è¯¯å¤„ç†ã€‚ç³»ç»Ÿå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **æ™ºèƒ½å¤„ç†**: æ ¹æ®å¯¹è¯ç±»å‹é€‰æ‹©æœ€é€‚åˆçš„å¤„ç†ç­–ç•¥
2. **è´¨é‡è¯„ä¼°**: å¤šç»´åº¦è´¨é‡æŒ‡æ ‡å®æ—¶ç›‘æ§
3. **å“åº”ä¼˜åŒ–**: JSONå’ŒMarkdownæ ¼å¼è‡ªåŠ¨ä¼˜åŒ–
4. **é”™è¯¯å¤„ç†**: å®Œå–„çš„å®¹é”™æœºåˆ¶ä¿è¯æœåŠ¡å¯ç”¨æ€§
5. **è´¨é‡ç›‘æ§**: è¯¦ç»†çš„è´¨é‡æŒ‡æ ‡å’Œæ—¥å¿—è®°å½•

ç³»ç»Ÿèƒ½å¤Ÿæœ‰æ•ˆå¤„ç†ä¸åŒå¯¹è¯ç±»å‹çš„å“åº”ï¼Œç¡®ä¿å“åº”è´¨é‡å’Œæ ¼å¼çš„æ­£ç¡®æ€§ï¼Œä¸ºå¤šè½®å¯¹è¯æä¾›ç¨³å®šçš„å“åº”å¤„ç†èƒ½åŠ›ã€‚

**ä¸‹ä¸€æ­¥**: ç»§ç»­è¿›è¡Œå¤šè½®å¯¹è¯åœºæ™¯æµ‹è¯•å’Œå‰ç«¯æ˜¾ç¤ºé€»è¾‘æ›´æ–°ã€‚
